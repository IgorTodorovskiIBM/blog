---
layout:       post
title:        "Porting TMUX to the z/OS"
author:       "Igor Todorovski"
header-img:   "img/in-post/ai_on_z.jpg"
catalog:      true
hidden:       true
tags:
    - z/OS
    - Porting
    - TMUX
    - Terminal Multiplexer
---

I'm excited to share my journey of porting TMUX, a popular terminal multiplexer, to z/OS! This project builds upon my previous experience successfully porting GNU screen and making it available under the z/OS Open Tools umbrella. Following the success of GNU screen, the z/OS community expressed a strong desire for TMUX in a recent poll, making it one of the most requested tools:

[INSERT IMAGE]

I'll delve into the challenges and solutions encountered while adapting TMUX to the z/OS environment, along with the benefits it brings to z/OS users. 

## Why Tmux on z/OS?

For z/OS users, particularly system administrators and developers, efficient management of multiple shell sessions is paramount. TMUX offers:

* **Multi-pane Workspaces:** Organize your terminal by splitting the window into panes, each running an independent program.
* **Detachable Sessions:** Leave your work running on z/OS even after disconnecting. Reattach seamlessly from any terminal later.
* **Enhanced Workflow:** Effortlessly switch between tasks, monitor multiple processes concurrently, and maintain a clutter-free terminal environment.

## How do I install it?

Grab it from z/OS Open Tools using the `zopen` package manager:

```
zopen install tmux -y
tmux
```

## Porting Tmux to z/OS

Porting TMUX to z/OS presented unique challenges due to the underlying differences between z/OS and traditional Unix-like systems. Let's explore some key areas and the solutions implemented:

* **Missing dependencies**: Tmux in itself does not have that many dependencies. It depends on libevent and ncurses. Fortunately ncurses has already been ported for other projects like Vim and Less so we only had to focus on getting libevent ported.

* **I/O Handling:** Standard Unix I/O operations might require special handling on z/OS. We leveraged functionalities provided by ZOSLIB (introduced in a previous blog post) to simplify I/O handling. ZOSLIB offers functions that address potential issues related to reading/writing from z/OS files and standard input/output.

## Conquering Dependency Challenges:

By leveraging the `zopen` build framework, we are able to port libevent fairly easily - https://github.com/ZOSOpenTools/libeventport. We had to make sure we exposed it as a library when we wre adding it as a depedenceny in Tmux - https://github.com/ZOSOpenTools/libeventport/blob/main/buildenv#L16-L26.

```
  export ZOPEN_EXTRA_CFLAGS="\${ZOPEN_EXTRA_CFLAGS} -I\$PWD/include"
  export ZOPEN_EXTRA_CXXFLAGS="\${ZOPEN_EXTRA_CXXFLAGS} -I\$PWD/include"
  export ZOPEN_EXTRA_LDFLAGS="\${ZOPEN_EXTRA_LDFLAGS} -L\$PWD/lib"
  export ZOPEN_EXTRA_LIBS="\${ZOPEN_EXTRA_LIBS} -levent"
```

Now we were ready to build Tmux.

## Building TMUX

As you can see, TMUX's buildenv configuration was relatively simple (https://github.com/ZOSOpenTools/meta). We added the known dependencies and chose the Clang compiler for building.

```
zopen build -v
```

## Overcoming the `forkpty` Challenge

Since `forkpty` is absent on z/OS, we employed an alternative approach utilizing existing POSIX functionalities. This involved creating a pseudo terminal by opening specific devices and manipulating terminal attributes to simulate a terminal environment for TMUX sessions.

## Testing and Debugging the Build

After testing the build, we encountered garbled output. To understand the issue, we leveraged TMUX's `-v` option for logging. After further investigation, we realized that the content written to the screen was actually readable and in ASCII format.

The culprit? `writev` was not respecting file tags and auto-conversion. This meant the text going to standard output wasn't being automatically converted to the terminal's CCSID (1047).

To resolve this, we modified the libevent code to use `write` instead of `writev`.
