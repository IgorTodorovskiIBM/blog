---
layout:       post
title:        "Porting tmux to the z/OS"
author:       "Igor Todorovski"
header-img:   "img/in-post/ai_on_z.jpg"
catalog:      true
hidden:       true
tags:
    - z/OS
    - Porting
    - tmux
    - Terminal Multiplexer
---

> With Tmux you never lose your workflow. Persistent workspaces, organized panes, boosted efficiency are all part of Tmux!

I'm excited to share my journey of porting tmux, a popular terminal multiplexer, to z/OS! This project builds upon my previous experience successfully porting GNU screen and making it available under the z/OS Open Tools umbrella. Following the success of GNU screen, the z/OS community expressed a strong desire for tmux in a recent poll, making it one of the most requested tools:

[INSERT IMAGE]

So what is Tmux?

> tmux is a terminal multiplexer. It lets you switch easily between several programs in one terminal, detach them (they keep running in the background) and reattach them to a different terminal.

<p style="text-align: center;">
<img src="/blog/img/in-post/tmux.gif" alt="tmux.cpp" style="float:center;">
Tmux running on z/OS
</p>

It has many advantages of GNU Screen, including mouse integration, supporting terminal splitting into both vertical and horizontal panes, and generally more configuration options.

## Why Tmux on z/OS?

For z/OS users, particularly system administrators and developers, efficient management of multiple shell sessions is paramount. tmux offers:

* **Multi-pane Workspaces:** Organize your terminal by splitting the window into panes, each running an independent program.
* **Detachable Sessions:** Leave your work running on z/OS even after disconnecting. Reattach seamlessly from any terminal later. This means you can sleep and resume where you left off the following morning.
* **Enhanced Workflow:** Easily switch between tasks, monitor multiple processes concurrently, and maintain a clutter-free terminal environment. This is one vital for me since I sometimes work on 5 different tasks simultenously! 

You can certainly run tmux remotely from a Linux machine to manage your screen sessions, but being able to run it locally on z/OS can improve latency and is especially good for air-gapped environments.


## How do I install it?

Grab it from z/OS Open Tools using the `zopen` package manager:

```
zopen install tmux -y
tmux
```

## Porting Tmux to z/OS

Porting tmux to z/OS presented unique challenges due to the underlying differences between z/OS and traditional Unix-like systems. Let's explore some key areas and the solutions implemented:

* **Missing dependencies**: Tmux in itself does not have that many dependencies. It depends on libevent and ncurses. Fortunately ncurses has already been ported for other projects like Vim and Less so we only had to focus on getting libevent ported.

* **I/O Handling:** Standard Unix I/O operations might require special handling on z/OS. We leveraged functionalities provided by ZOSLIB (introduced in the [previous blog post](https://igortodorovskiibm.github.io/blog/) to simplify I/O handling. 

## Conquering Dependency Challenges:

By leveraging the `zopen` build framework, we were able to port libevent fairly easily. The port is available at https://github.com/ZOSOpenTools/libeventport. Since libevent is a library, we had to make sure we exposed it as a library when we were adding it as a depedenceny for Tmux.

```
  export ZOPEN_EXTRA_CFLAGS="\${ZOPEN_EXTRA_CFLAGS} -I\$PWD/include"
  export ZOPEN_EXTRA_CXXFLAGS="\${ZOPEN_EXTRA_CXXFLAGS} -I\$PWD/include"
  export ZOPEN_EXTRA_LDFLAGS="\${ZOPEN_EXTRA_LDFLAGS} -L\$PWD/lib"
  export ZOPEN_EXTRA_LIBS="\${ZOPEN_EXTRA_LIBS} -levent"
```
For a detailed look on how we build it, check out the buildenv configuration here https://github.com/ZOSOpenTools/libeventport/blob/main/buildenv#L16-L26.

Now we were ready to build Tmux.

## Building tmux

As you can see, tmux's buildenv configuration was relatively simple (https://github.com/ZOSOpenTools/meta). We added the known dependencies and chose the Clang compiler for building.

```
zopen build -v
```

## Overcoming the `forkpty` Challenge

Since `forkpty` is absent on z/OS, we employed an alternative approach utilizing existing POSIX functionalities. This involved creating a pseudo terminal by opening specific devices and manipulating terminal attributes to simulate a terminal environment for tmux sessions.

## Testing and Debugging the Build

After testing the build, we encountered garbled output. To understand the issue, we leveraged tmux's `-v` option for logging. After further investigation, we realized that the content written to the screen was actually readable and in ASCII format.

The culprit? `writev` was not respecting file tags and auto-conversion. This meant the text going to standard output wasn't being automatically converted to the terminal's CCSID (1047).

To resolve this, we modified the libevent code to use `write` instead of `writev`.
